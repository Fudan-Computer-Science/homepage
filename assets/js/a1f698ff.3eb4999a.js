(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[6190],{18639:(n,e,s)=>{"use strict";s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>m,frontMatter:()=>d,metadata:()=>t,toc:()=>p});const t=JSON.parse('{"id":"\u8b1b\u7fa9/\u8b1b\u7fa9/Web_textbook/DDJv2-guide/DDJv2-addon/Chapter6","title":"\u7b2c\u516d\u7ae0 Handler \u7269\u4ef6\u4ecb\u7d39","description":"\u4ecb\u7d39 HydroOJ \u670d\u52d9\u4e2d\u7684 Handler \u7269\u4ef6","source":"@site/docs/\u8b1b\u7fa9/\u8b1b\u7fa9/02-Web_textbook/01-DDJv2-guide/02-DDJv2-addon/06-Chapter6.mdx","sourceDirName":"\u8b1b\u7fa9/\u8b1b\u7fa9/02-Web_textbook/01-DDJv2-guide/02-DDJv2-addon","slug":"/\u8b1b\u7fa9/\u8b1b\u7fa9/Web_textbook/DDJv2-guide/DDJv2-addon/Chapter6","permalink":"/homepage/docs/\u8b1b\u7fa9/\u8b1b\u7fa9/Web_textbook/DDJv2-guide/DDJv2-addon/Chapter6","draft":false,"unlisted":false,"editUrl":"https://github.com/Fudan-Computer-Science/homepage/tree/main/docs/\u8b1b\u7fa9/\u8b1b\u7fa9/02-Web_textbook/01-DDJv2-guide/02-DDJv2-addon/06-Chapter6.mdx","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6,"title":"\u7b2c\u516d\u7ae0 Handler \u7269\u4ef6\u4ecb\u7d39","description":"\u4ecb\u7d39 HydroOJ \u670d\u52d9\u4e2d\u7684 Handler \u7269\u4ef6"},"sidebar":"tutorialSidebar","previous":{"title":"\u7b2c\u4e94\u7ae0 Context \u7269\u4ef6\u4ecb\u7d39","permalink":"/homepage/docs/\u8b1b\u7fa9/\u8b1b\u7fa9/Web_textbook/DDJv2-guide/DDJv2-addon/Chapter5"},"next":{"title":"\u9644\u9304 -- HydroOJ \u6574\u9ad4\u67b6\u69cb\u6d41\u7a0b\u5716","permalink":"/homepage/docs/\u8b1b\u7fa9/\u8b1b\u7fa9/Web_textbook/DDJv2-guide/DDJv2-addon/Appendix"}}');var a=s(74848),r=s(28453),i=s(80644),l=s(24454);const d={sidebar_position:6,title:"\u7b2c\u516d\u7ae0 Handler \u7269\u4ef6\u4ecb\u7d39",description:"\u4ecb\u7d39 HydroOJ \u670d\u52d9\u4e2d\u7684 Handler \u7269\u4ef6"},o="Chapter 6. ",c={},p=[{value:"Handler \u7269\u4ef6\u4ecb\u7d39",id:"handler-\u7269\u4ef6\u4ecb\u7d39",level:2},{value:"Handler \u88dd\u98fe\u5668",id:"handler-\u88dd\u98fe\u5668",level:3},{value:"Handler \u5167\u5efa\u65b9\u6cd5",id:"handler-\u5167\u5efa\u65b9\u6cd5",level:3},{value:"\u6e32\u67d3\u6a5f\u5236",id:"\u6e32\u67d3\u6a5f\u5236",level:3},{value:"\u97ff\u61c9\u985e\u578b",id:"\u97ff\u61c9\u985e\u578b",level:4},{value:"\u6a21\u677f\u7cfb\u7d71",id:"\u6a21\u677f\u7cfb\u7d71",level:2},{value:"\u6578\u64da\u50b3\u905e",id:"\u6578\u64da\u50b3\u905e",level:2}];function h(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...n.components};return(0,a.jsxs)(i.uw,{base:"/img/DDJv2-guide/DDJv2-addon/06-Chapter6",children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"chapter-6-",children:(0,a.jsx)("span",{class:"chapter_title",children:"Chapter 6. "})})}),(0,a.jsx)(e.h1,{id:"-handler-object-introduction-",children:(0,a.jsx)("span",{class:"chapter_subtitle",children:" Handler Object Introduction "})}),(0,a.jsxs)(e.p,{children:["Handler \u57fa\u790e\u7d50\u69cb\u53ef\u5148\u95b1\u8b80",(0,a.jsx)(e.a,{href:"../Appendix#handler-%E7%9B%B8%E9%97%9C%E9%99%84%E9%8C%84",children:"\u9644\u9304\uff1aHandler \u76f8\u95dc\u9644\u9304"}),"\u65b9\u4fbf\u7406\u89e3"]}),(0,a.jsx)(e.h2,{id:"handler-\u7269\u4ef6\u4ecb\u7d39",children:"Handler \u7269\u4ef6\u4ecb\u7d39"}),(0,a.jsx)(e.p,{children:"\u5728 HydroOJ \u4e2d\uff0cHandler \u7269\u4ef6\u4ee3\u8868\u8655\u7406 HTTP \u8acb\u6c42\u7684\u6838\u5fc3\u55ae\u5143\u3002\u6bcf\u500b Handler \u8ca0\u8cac\u8655\u7406\u8def\u7531\u8acb\u6c42\uff0c\u4e26\u751f\u6210\u76f8\u61c9\u7684\u97ff\u61c9\u3002"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"import {\n    Handler \n} from 'hydrooj';\n\nclass ProblemCategoryCompatHandler extends Handler {\n  // GET /p/category/:category\n  async get({ category }) {\n    // \u91cd\u5b9a\u5411\u5230\u65b0\u7684\u641c\u7d22\u9801\u9762\n    this.response.redirect = this.url('problem_main', { \n      query: { q: `category:${category}` } \n    });\n  }\n}\n\nexport const apply = (ctx) => {\n  ctx.Route(\n    'problem_category_compat',\n    '/p/category/:category',\n    ProblemCategoryCompatHandler\n  );\n};\n// \u5982\u679c\u4f60\u8a2a\u554f /p/category/math \u5c07\u6703\u88ab\u91cd\u5b9a\u5411\u5230 /p?query=category:math\n"})}),(0,a.jsx)(e.h3,{id:"handler-\u88dd\u98fe\u5668",children:"Handler \u88dd\u98fe\u5668"}),(0,a.jsx)(e.p,{children:"HydroOJ \u63d0\u4f9b\u4e86\u4e00\u4e9b\u88dd\u98fe\u5668\u4f86\u7c21\u5316 Handler \u7684\u5b9a\u7fa9\u548c\u884c\u70ba\u63a7\u5236\u3002\n0. @subscribe - \u8a02\u95b1\u4e8b\u4ef6"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"// \u4f86\u6e90: packages/hydrooj/src/handler/record.ts\nexport class RecordDetailConnectionHandler extends ConnectionHandler {\n  rid: string = '';\n  \n  @param('rid', Types.ObjectId)\n  async prepare(domainId: string, rid: ObjectId) {\n    this.rid = rid.toString();\n  }\n  \n  // \u8a02\u95b1 record/change \u4e8b\u4ef6\n  @subscribe('record/change')\n  async onRecordChange(rdoc: RecordDoc, $set?: any, $push?: any) {\n    // \u53ea\u8655\u7406\u5339\u914d\u7684\u8a18\u9304\n    if (rdoc._id.toString() !== this.rid) return;\n    \n    // \u767c\u9001\u66f4\u65b0\u5230\u5ba2\u6236\u7aef\n    this.send({\n      status: rdoc.status,\n      score: rdoc.score,\n      time: rdoc.time,\n      memory: rdoc.memory\n    });\n  }\n}\n"})}),(0,a.jsxs)(e.p,{children:["\u6709\u6c92\u6709\u89ba\u5f97\u5f88\u773c\u719f\uff1f \u6c92\u932f \u9019\u5c31\u662f\u6211\u5011\u4e0a\u4e00\u7ae0\u63d0\u5230",(0,a.jsx)(e.a,{href:"../Chapter5#ctx.on()",children:"ctx.on"}),"\u7684Handler\u7248\u672c\n\u6240\u4ee5\u4e8b\u4ef6\u7a2e\u985e\u548c\u7d30\u7bc0\u8acb\u53c3\u8003",(0,a.jsx)(e.a,{href:"../Chapter5",children:"\u7b2c\u4e94\u7ae0"}),"\u7684\u4ecb\u7d39"]}),(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"@param - \u53c3\u6578\u9a57\u8b49"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"import { param, Types, ValidationError } from 'hydrooj';\n\nclass ExampleHandler extends Handler {\n  // \u57fa\u672c\u985e\u578b\n  @param('name', Types.String)\n  @param('age', Types.Int)\n  @param('email', Types.Email)\n  async get(domainId: string, name: string, age: number, email: string) {\n    // name, age, email \u5df2\u9a57\u8b49\n  }\n\n  // \u53ef\u9078\u53c3\u6578\n  @param('page', Types.PositiveInt, true)  // \u7b2c\u4e09\u500b\u53c3\u6578\u70ba true \u8868\u793a\u53ef\u9078\n  async list(domainId: string, page = 1) {\n    // page \u5982\u679c\u6c92\u63d0\u4f9b\uff0c\u4f7f\u7528\u9ed8\u8a8d\u503c 1\n  }\n\n  // \u8907\u96dc\u985e\u578b\n  @param('tid', Types.ObjectId)\n  @param('pids', Types.NumericArray)\n  @param('files', Types.ArrayOf(Types.Filename))\n  async post(\n    domainId: string,\n    tid: ObjectId,\n    pids: number[],\n    files: string[]\n  ) {\n    // \u6240\u6709\u53c3\u6578\u5df2\u9a57\u8b49\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"2",children:["\n",(0,a.jsx)(e.li,{children:"@post - POST \u5c08\u7528\u88dd\u98fe\u5668"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"import { post, Types } from 'hydrooj';\n\nclass FileHandler extends Handler {\n  // GET \u8acb\u6c42\n  async get() {\n    this.response.template = 'files.html';\n  }\n\n  // POST \u64cd\u4f5c\uff1a\u4e0a\u50b3\n  @post('filename', Types.Filename)\n  async postUpload(domainId: string, filename: string) {\n    const file = this.request.files?.file;\n    if (!file) throw new ValidationError('file');\n    \n    await storage.put(`files/${filename}`, file.filepath);\n    this.back();\n  }\n\n  // POST \u64cd\u4f5c\uff1a\u522a\u9664\n  @post('files', Types.ArrayOf(Types.Filename))\n  async postDelete(domainId: string, files: string[]) {\n    await storage.del(files);\n    this.back();\n  }\n}\n"})}),(0,a.jsxs)(e.p,{children:["(",(0,a.jsx)(e.a,{href:"../Appendix#storage",children:"storage"})," \u4ecb\u7d39 \u672a\u6b78\u6a94)\n3. @query - \u67e5\u8a62\u53c3\u6578"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"import { query, Types } from 'hydrooj';\n\nclass ListHandler extends Handler {\n  @query('page', Types.PositiveInt, true)\n  @query('sort', Types.Range(['asc', 'desc']), true)\n  async get(domainId: string, page = 1, sort = 'desc') {\n    // \u5f9e URL \u67e5\u8a62\u53c3\u6578\u7372\u53d6: ?page=2&sort=asc\n    const items = await getItems(page, sort);\n    this.response.body = { items, page, sort };\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"4",children:["\n",(0,a.jsx)(e.li,{children:"@requireSudo - \u9700\u8981 Sudo \u6b0a\u9650"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"import { requireSudo } from 'hydrooj';\n\nclass DangerousOperationHandler extends Handler {\n  @requireSudo\n  async postDelete() {\n    // \u9700\u8981\u7528\u6236\u6700\u8fd1\u9032\u884c\u904e sudo \u9a57\u8b49\n    // \u5982\u679c\u6c92\u6709\uff0c\u6703\u91cd\u5b9a\u5411\u5230 sudo \u9801\u9762\n    await deleteAllData();\n    this.back();\n  }\n}\n"})}),(0,a.jsx)(e.h3,{id:"handler-\u5167\u5efa\u65b9\u6cd5",children:"Handler \u5167\u5efa\u65b9\u6cd5"}),(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u97ff\u61c9\u76f8\u95dc"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class ExampleHandler extends Handler {\n  async get() {\n    // 1. \u8a2d\u7f6e\u6a21\u677f\n    this.response.template = 'example.html';\n    this.response.body = { data: 'value' };\n\n    // 2. \u91cd\u5b9a\u5411\n    this.response.redirect = '/other-page';\n    // \u6216\u4f7f\u7528 url() \u751f\u6210\n    this.response.redirect = this.url('problem_main');\n\n    // 3. JSON \u97ff\u61c9\n    this.response.body = { success: true };\n    this.response.type = 'application/json';\n\n    // 4. \u4e8c\u9032\u5236\u4e0b\u8f09\n    this.binary(fileData, 'filename.zip');\n\n    // 5. \u8fd4\u56de\u4e0a\u4e00\u9801\n    this.back();\n    // \u6216\u5e36\u6578\u64da\n    this.back({ success: true });\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"2",children:["\n",(0,a.jsx)(e.li,{children:"\u6b0a\u9650\u6aa2\u67e5"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class SecureExampleHandler extends Handler {\n  async get() {\n    // 1. \u6aa2\u67e5\u6b0a\u9650\n    this.checkPerm(PERM.PERM_EDIT_PROBLEM);\n\n    // 2. \u6aa2\u67e5\u7279\u6b0a\n    this.checkPriv(PRIV.PRIV_USER_PROFILE);\n\n    // 3. \u6aa2\u67e5\u591a\u500b\u6b0a\u9650\n    this.checkPerm(\n      PERM.PERM_VIEW_PROBLEM,\n      PERM.PERM_SUBMIT_PROBLEM\n    );\n\n    // 4. \u689d\u4ef6\u6aa2\u67e5\n    if (!this.user.own(pdoc)) {\n      this.checkPerm(PERM.PERM_EDIT_PROBLEM);\n    } else {\n      this.checkPerm(PERM.PERM_EDIT_PROBLEM_SELF);\n    }\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"3",children:["\n",(0,a.jsx)(e.li,{children:"\u901f\u7387\u9650\u5236"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class RateLimitedExampleHandler extends Handler {\n  async post() {\n    // limitRate(\u64cd\u4f5c\u540d, \u6642\u9593\u6bb5(\u79d2), \u6700\u5927\u6b21\u6578, \u9375)\n    await this.limitRate('submit_problem', 60, 10);\n    // \u4e00\u5206\u9418\u5167\u6700\u591a\u63d0\u4ea4 10 \u6b21\n\n    await this.limitRate('send_mail', 3600, 3);\n    // \u4e00\u5c0f\u6642\u5167\u6700\u591a\u767c\u9001 3 \u6b21\u90f5\u4ef6\n\n    // \u81ea\u5b9a\u7fa9\u9375\n    await this.limitRate('create', 3600, 100, '{{ip}}');\n    // \u57fa\u65bc IP \u9650\u5236\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"4",children:["\n",(0,a.jsx)(e.li,{children:"URL \u751f\u6210"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class UrlExampleHandler extends Handler {\n  async get() {\n    // 1. \u57fa\u672c URL\n    const url1 = this.url('problem_main');\n    // \u7d50\u679c: /p\n\n    // 2. \u5e36\u53c3\u6578\n    const url2 = this.url('problem_detail', { pid: 1000 });\n    // \u7d50\u679c: /p/1000\n\n    // 3. \u5e36\u67e5\u8a62\u53c3\u6578\n    const url3 = this.url('problem_main', { \n      query: { page: 2, q: 'search' } \n    });\n    // \u7d50\u679c: /p?page=2&q=search\n\n    // 4. \u5e36\u9328\u9ede\n    const url4 = this.url('problem_detail', { \n      pid: 1000, \n      anchor: 'solution' \n    });\n    // \u7d50\u679c: /p/1000#solution\n\n    // 5. \u8de8\u57df URL\n    const url5 = this.url('problem_main', { \n      domainId: 'another' \n    });\n    // \u7d50\u679c: /d/another/p\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"5",children:["\n",(0,a.jsx)(e.li,{children:"\u7ffb\u8b6f\u548c\u6e32\u67d3"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class I18nExampleHandler extends Handler {\n  async get() {\n    // 1. \u7ffb\u8b6f\u6587\u672c\n    const text = this.translate('Welcome');\n    \n    // 2. \u5e36\u53c3\u6578\u7684\u7ffb\u8b6f\n    const msg = this.translate('Hello {0}', [this.user.uname]);\n\n    // 3. \u6e32\u67d3\u6a19\u984c\n    const title = this.renderTitle('Problem List');\n    // \u7d50\u679c: \"Problem List - Site Name\"\n\n    // 4. \u6e32\u67d3 HTML\n    const html = await this.renderHTML('partial.html', { \n      data: 'value' \n    });\n\n    // 5. \u9032\u5ea6\u5831\u544a\n    this.progress('Processing...', ['param']);\n    // \u767c\u9001\u6d88\u606f\u7d66\u7528\u6236\n  }\n}\n"})}),(0,a.jsx)(e.h3,{id:"\u6e32\u67d3\u6a5f\u5236",children:"\u6e32\u67d3\u6a5f\u5236"}),(0,a.jsxs)(e.p,{children:["\u53c3\u8003",(0,a.jsx)(e.a,{href:"../Appendix#%E6%B8%B2%E6%9F%93%E6%A9%9F%E5%88%B6%E6%B5%81%E7%A8%8B%E5%9C%96",children:"\u9644\u9304\uff1aHandler \u76f8\u95dc\u9644\u9304"})]}),(0,a.jsx)(e.mermaid,{value:'graph TD\n    A["Handler \u57f7\u884c"] --\x3e B["\u8a2d\u7f6e this.response"]\n    B --\x3e B1["body \u6578\u64da"]\n    B --\x3e B2["template \u6a21\u677f"]\n    B --\x3e B3["type \u985e\u578b"]\n    B --\x3e B4["redirect \u91cd\u5b9a\u5411"]\n    B1 --\x3e C["Handler \u7d50\u675f"]\n    B2 --\x3e C\n    B3 --\x3e C\n    B4 --\x3e C\n    C --\x3e D["\u6e32\u67d3\u5f15\u64ce\u9078\u64c7"]\n    D --\x3e|\u6709 redirect?| E["\u91cd\u5b9a\u5411"]\n    D --\x3e|\u6709 template?| F["\u6a21\u677f\u6e32\u67d3"]\n    D --\x3e|JSON \u8acb\u6c42?| G["JSON \u97ff\u61c9"]\n    D --\x3e|\u5176\u4ed6| H["\u76f4\u63a5\u8fd4\u56de body"]\n    E --\x3e I["\u767c\u9001\u7d66\u5ba2\u6236\u7aef"]\n    F --\x3e I\n    G --\x3e I\n    H --\x3e I'}),(0,a.jsx)(e.h4,{id:"\u97ff\u61c9\u985e\u578b",children:"\u97ff\u61c9\u985e\u578b"}),(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u6a21\u677f\u6e32\u67d3\uff08HTML\uff09"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class TemplateRenderHandler extends Handler {\n  async get() {\n    // \u8a2d\u7f6e\u6a21\u677f\u548c\u6578\u64da\n    this.response.template = 'problem_detail.html';\n    this.response.body = {\n      pdoc: this.pdoc,\n      udoc: this.udoc,\n      psdoc: this.psdoc,\n    };\n    \n    // \u6846\u67b6\u81ea\u52d5\u6e32\u67d3\u6a21\u677f\u4e26\u8fd4\u56de HTML\n  }\n}\n\n// \u6e32\u67d3\u7d50\u679c\n// \u2192 Nunjucks \u6e32\u67d3 'problem_detail.html'\n// \u2192 \u50b3\u5165 { pdoc, udoc, psdoc }\n// \u2192 \u8fd4\u56de\u5b8c\u6574 HTML \u9801\u9762\n"})}),(0,a.jsxs)(e.ol,{start:"2",children:["\n",(0,a.jsx)(e.li,{children:"JSON \u97ff\u61c9"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:'class JsonHandler extends Handler {\n  async get() {\n    const data = await fetchData();\n    \n    // \u65b9\u5f0f 1: \u6846\u67b6\u81ea\u52d5\u6aa2\u6e2c\n    this.response.body = { \n      success: true, \n      data \n    };\n    // \u5982\u679c\u8acb\u6c42\u982d\u5305\u542b Accept: application/json\n    // \u2192 \u81ea\u52d5\u8fd4\u56de JSON\n    \n    // \u65b9\u5f0f 2: \u660e\u78ba\u6307\u5b9a\n    this.response.type = \'application/json\';\n    this.response.body = { data };\n  }\n}\n\n// API \u8acb\u6c42\u793a\u4f8b\n// GET /api/data\n// Accept: application/json\n// \n// Response:\n// Content-Type: application/json\n// { "success": true, "data": [...] }\n'})}),(0,a.jsxs)(e.ol,{start:"3",children:["\n",(0,a.jsx)(e.li,{children:"\u91cd\u5b9a\u5411"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class RedirectHandler extends Handler {\n  async get() {\n    // \u65b9\u5f0f 1: \u76f4\u63a5\u91cd\u65b0\u5c0e\u5411 URL\n    this.response.redirect = '/target-page';\n    \n    // \u65b9\u5f0f 2: \u4f7f\u7528 url() \u751f\u6210\n    this.response.redirect = this.url('problem_detail', { \n      pid: 1000 \n    });\n    \n    // \u65b9\u5f0f 3: \u56de\u5230\u4e0a\u4e00\u9801\n    this.back();\n    // \u7b49\u540c\u65bc\n    this.response.redirect = this.request.headers.referer || '/';\n    \n    // \u65b9\u5f0f 4: \u5e36\u6578\u64da\u56de\u5230\u4e0a\u4e00\u9801\n    this.back({ success: true, message: 'Done' });\n    // \u2192 \u91cd\u5b9a\u5411 + \u8a2d\u7f6e body\uff08\u7528\u65bc\u67d0\u4e9b\u5834\u666f\uff09\n  }\n}\n\n// HTTP \u97ff\u61c9\n// HTTP/1.1 302 Found\n// Location: /target-page\n"})}),(0,a.jsxs)(e.ol,{start:"4",children:["\n",(0,a.jsx)(e.li,{children:"PJAX \u90e8\u5206\u6e32\u67d3"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class PjaxHandler extends Handler {\n  @param('page', Types.PositiveInt, true)\n  async get(domainId: string, page = 1) {\n    const [items, count] = await getItems(page);\n    \n    // \u8a2d\u7f6e PJAX \u6a21\u677f\n    this.response.pjax = 'partials/item_list.html';\n    // \u6216\u591a\u500b\u90e8\u5206\n    this.response.pjax = [\n      ['partials/list.html', { items }],\n      ['partials/pagination.html', { page, count }]\n    ];\n    \n    this.response.template = 'full_page.html';\n    this.response.body = { items, count, page };\n  }\n}\n\n// \u6e32\u67d3\u908f\u8f2f\n// \u5982\u679c\u662f PJAX \u8acb\u6c42\uff1a\n//   \u2192 \u53ea\u6e32\u67d3 pjax \u6307\u5b9a\u7684\u90e8\u5206\n//   \u2192 \u8fd4\u56de HTML \u7247\u6bb5\n// \u5426\u5247\uff1a\n//   \u2192 \u6e32\u67d3\u5b8c\u6574 template\n//   \u2192 \u8fd4\u56de\u5b8c\u6574\u9801\u9762\n"})}),(0,a.jsxs)(e.ol,{start:"5",children:["\n",(0,a.jsx)(e.li,{children:"\u4e8c\u9032\u5236\u4e0b\u8f09"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class DownloadHandler extends Handler {\n  async get() {\n    const fileData = await readFile('example.zip');\n    \n    // \u65b9\u5f0f 1: \u4f7f\u7528 binary()\n    this.binary(fileData, 'example.zip');\n    \n    // \u65b9\u5f0f 2: \u624b\u52d5\u8a2d\u7f6e\n    this.response.body = fileData;\n    this.response.type = 'application/octet-stream';\n    this.response.disposition = 'attachment; filename=\"example.zip\"';\n  }\n}\n\n// HTTP \u97ff\u61c9\n// Content-Type: application/octet-stream\n// Content-Disposition: attachment; filename=\"example.zip\"\n// [\u4e8c\u9032\u5236\u6578\u64da]\n"})}),(0,a.jsxs)(e.ol,{start:"6",children:["\n",(0,a.jsx)(e.li,{children:"\u6587\u4ef6\u6d41\u5f0f\u50b3\u8f38"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class StreamHandler extends Handler {\n  async get() {\n    // \u4f7f\u7528\u5b58\u5132\u670d\u52d9\u7684\u7c3d\u540d\u4e0b\u8f09\u93c8\u63a5\n    this.response.redirect = await storage.signDownloadLink(\n      'path/to/file',\n      'filename.pdf',\n      false,  // inline (\u5728\u700f\u89bd\u5668\u4e2d\u6253\u958b)\n      'user'  // \u6b0a\u9650\u985e\u578b\n    );\n  }\n}\n\n// \u6216\u76f4\u63a5\u9644\u4ef6\nclass AttachmentHandler extends Handler {\n  async get() {\n    const stream = fs.createReadStream('file.pdf');\n    this.response.attachment('document.pdf', stream);\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"7",children:["\n",(0,a.jsx)(e.li,{children:"\u7d14\u6587\u672c\u97ff\u61c9"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class TextHandler extends Handler {\n  async get() {\n    this.response.body = 'Plain text content';\n    this.response.type = 'text/plain'; // \u53ef\u9078\n  }\n}\n"})}),(0,a.jsxs)(e.ol,{start:"8",children:["\n",(0,a.jsx)(e.li,{children:"XML \u97ff\u61c9"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class XmlHandler extends Handler {\n  async get() {\n    const xml = `<?xml version=\"1.0\"?>\n      <root>\n        <item>value</item>\n      </root>`;\n    \n    this.response.body = xml;\n    this.response.type = 'application/xml';\n  }\n}\n"})}),(0,a.jsx)(e.h2,{id:"\u6a21\u677f\u7cfb\u7d71",children:"\u6a21\u677f\u7cfb\u7d71"}),(0,a.jsxs)(e.p,{children:["HydroOJ \u4f7f\u7528 Nunjucks \u4f5c\u70ba\u6a21\u677f\u5f15\u64ce\uff1a\n\u8a73\u7d30\u7d50\u69cb\u8acb\u53c3\u8003\u9644\u9304\u4e2d\u7684",(0,a.jsx)(e.a,{href:"../Appendix#%E6%A8%A1%E6%9D%BF%E7%B3%BB%E7%B5%B1%E7%9B%B8%E9%97%9C%E9%99%84%E9%8C%84",children:"\u6a21\u677f\u7cfb\u7d71\u76f8\u95dc\u9644\u9304"})]}),(0,a.jsxs)(e.p,{children:["\u6a21\u677f\u6e32\u67d3\u525b\u525b\u4ecb\u7d39 Handler \u4e2d\u5df2\u6709\u4ecb\u7d39 \uff08\u4ec0\u9ebc \u4f60\u6c92\u770b\u5230\uff1f ",(0,a.jsx)(e.a,{href:"#%E9%9F%BF%E6%87%89%E9%A1%9E%E5%9E%8B",children:"\u56de\u53bb\u770b\u4e00\u904d\uff01"})]}),(0,a.jsx)(e.p,{children:"\u6a21\u677f\u6e32\u67d3\u793a\u4f8b"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class TemplateExampleHandler extends Handler {\n  async get(domainId: string, pid: number) {\n    const [pdoc, psdict, udoc] = await Promise.all([\n      problem.get(domainId, pid),\n      problem.getStatus(domainId, pid, this.user._id),\n      user.getById(domainId, this.user._id)\n    ]);\n    \n    // \u8a2d\u7f6e\u6a21\u677f\n    this.response.template = 'problem_detail.html';\n    \n    // \u8a2d\u7f6e\u6578\u64da\n    this.response.body = {\n      pdoc,      // \u984c\u76ee\u6578\u64da\n      psdict,    // \u72c0\u614b\u6578\u64da\n      udoc,      // \u7528\u6236\u6578\u64da\n    };\n  }\n}\n"})}),(0,a.jsx)(e.p,{children:"\u5c0d\u61c9\u7684 Nunjucks \u6a21\u677f(problem_detail.html)\uff1a"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nunjucks",children:"\x3c!-- problem_detail.html --\x3e\n{% extends \"layout/basic.html\" %}\n\n{% block content %}\n<div class=\"problem\">\n  \x3c!-- \u8a2a\u554f Handler \u50b3\u5165\u7684\u6578\u64da --\x3e\n  <h1>{{ pdoc.title }}</h1>\n  \n  \x3c!-- \u4f7f\u7528\u7ffb\u8b6f\u51fd\u6578 --\x3e\n  <p>{{ _('Problem ID') }}: {{ pdoc.pid }}</p>\n  \n  \x3c!-- \u4f7f\u7528 URL \u751f\u6210 --\x3e\n  <a href=\"{{ url('problem_submit', pid=pdoc.pid) }}\">\n    {{ _('Submit') }}\n  </a>\n  \n  \x3c!-- \u8a2a\u554f\u7528\u6236\u4fe1\u606f --\x3e\n  <div class=\"user\">\n    {{ _('Logged in as') }}: {{ user.uname }}\n  </div>\n  \n  \x3c!-- \u689d\u4ef6\u6e32\u67d3 --\x3e\n  {% if psdict.status == STATUS_ACCEPTED %}\n    <div class=\"alert success\">\n      {{ _('You have solved this problem') }}\n    </div>\n  {% endif %}\n  \n  \x3c!-- \u5faa\u74b0\u6e32\u67d3 --\x3e\n  {% for sample in pdoc.samples %}\n    <div class=\"sample\">\n      <h3>{{ _('Sample Input') }}</h3>\n      <pre>{{ sample[0] }}</pre>\n      <h3>{{ _('Sample Output') }}</h3>\n      <pre>{{ sample[1] }}</pre>\n    </div>\n  {% endfor %}\n</div>\n{% endblock %}\n"})}),(0,a.jsx)(e.p,{children:"\u90e8\u5206\u6a21\u677f\u6e32\u67d3"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class PartialRenderHandler extends Handler {\n  async get() {\n    const items = await getItems();\n    \n    // \u8a2d\u7f6e\u5b8c\u6574\u9801\u9762\u6a21\u677f\n    this.response.template = 'list_page.html';\n    \n    // \u5982\u679c\u662f PJAX \u8acb\u6c42\uff0c\u53ea\u6e32\u67d3\u5217\u8868\u90e8\u5206\n    this.response.pjax = 'partials/item_list.html';\n    \n    this.response.body = { items };\n  }\n}\n"})}),(0,a.jsx)(e.p,{children:"\u5c0d\u61c9\u7684\u670d\u52d9\u985e\u578b(list_page.html)\uff1a"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nunjucks",children:'\x3c!-- list_page.html - \u5b8c\u6574\u9801\u9762 --\x3e\n{% extends "layout/basic.html" %}\n\n{% block content %}\n<div class="list-container">\n  \x3c!-- \u5305\u542b\u90e8\u5206\u6a21\u677f --\x3e\n  {% include "partials/item_list.html" %}\n</div>\n{% endblock %}\n\n\x3c!-- partials/item_list.html - \u90e8\u5206\u6a21\u677f --\x3e\n<ul class="item-list">\n  {% for item in items %}\n    <li>{{ item.name }}</li>\n  {% endfor %}\n</ul>\n'})}),(0,a.jsx)(e.h2,{id:"\u6578\u64da\u50b3\u905e",children:"\u6578\u64da\u50b3\u905e"}),(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u5f9e Handler \u5230\u6a21\u677f"}),"\n"]}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class DataPassHandler extends Handler {\n  async get() {\n    this.response.template = 'example.html';\n    this.response.body = {\n      // \u57fa\u672c\u6578\u64da\n      title: 'Example',\n      count: 100,\n      \n      // \u6578\u7d44\n      items: [1, 2, 3],\n      \n      // \u5c0d\u8c61\n      user: { name: 'Alice', age: 30 },\n      \n      // \u51fd\u6578\uff08\u53ef\u5728\u6a21\u677f\u4e2d\u8abf\u7528\uff09\n      formatDate: (date) => new Date(date).toLocaleDateString(),\n      \n      // \u5d4c\u5957\u6578\u64da\n      nested: {\n        deep: {\n          value: 'test'\n        }\n      }\n    };\n  }\n}\n"})}),(0,a.jsx)(e.p,{children:"\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\uff1a"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nunjucks",children:"\x3c!-- \u8a2a\u554f\u57fa\u672c\u6578\u64da --\x3e\n<h1>{{ title }}</h1>\n<p>Count: {{ count }}</p>\n\n\x3c!-- \u904d\u6b77\u6578\u7d44 --\x3e\n{% for item in items %}\n  <li>{{ item }}</li>\n{% endfor %}\n\n\x3c!-- \u8a2a\u554f\u5c0d\u8c61 --\x3e\n<p>User: {{ user.name }} ({{ user.age }})</p>\n\n\x3c!-- \u8abf\u7528\u51fd\u6578 --\x3e\n<p>Date: {{ formatDate('2024-01-01') }}</p>\n\n\x3c!-- \u8a2a\u554f\u5d4c\u5957\u6578\u64da --\x3e\n<p>{{ nested.deep.value }}</p>\n"})}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class UiContextHandler extends Handler {\n  async get() {\n    // \u8a2d\u7f6e UI \u4e0a\u4e0b\u6587\n    this.UiContext.extraTitleContent = 'Custom Title';\n    this.UiContext.cdn = 'https://cdn.example.com';\n    this.UiContext.customData = { key: 'value' };\n    \n    this.response.template = 'page.html';\n    this.response.body = { content: 'Page content' };\n  }\n}\n"})}),(0,a.jsx)(e.p,{children:"\u6a21\u677f\u4e2d\u8a2a\u554f\uff1a"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nunjucks",children:'<title>\n  {{ UiContext.extraTitleContent }} - {{ _(\'Site Name\') }}\n</title>\n\n<script src="{{ UiContext.cdn }}/script.js"><\/script>\n\n<div data-custom="{{ UiContext.customData | json }}"></div>\n'})}),(0,a.jsx)(e.p,{children:"\u97ff\u61c9\u982d\u8a2d\u7f6e"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"class HeaderHandler extends Handler {\n  async get() {\n    // \u6dfb\u52a0\u81ea\u5b9a\u7fa9\u97ff\u61c9\u982d\n    this.response.addHeader('X-Custom-Header', 'value');\n    \n    // \u8a2d\u7f6e ETag\n    this.response.etag = 'abc123';\n    \n    // \u8a2d\u7f6e\u7de9\u5b58\n    this.response.addHeader('Cache-Control', 'public, max-age=3600');\n    \n    this.response.body = { data: 'content' };\n  }\n}\n"})}),(0,a.jsx)(l.A,{authors:["14thAdvancedTeachingDirector"],size:"h3"})]})}function m(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(h,{...n})}):h(n)}},24454:(n,e,s)=>{"use strict";s.d(e,{A:()=>l});s(96540);var t=s(39695),a=s.n(t),r=s(39907),i=s(74848);function l({authors:n,size:e="h1"}){if(!n||0===n.length)return(0,i.jsx)("div",{style:{marginTop:20,marginBottom:20},children:"No authors found."});const s=n.map((n=>{const e=a()[n];return e?{key:n,...e}:(console.warn(`Author key "${n}" not found in authors.yml`),null)})).filter(Boolean);if(0===s.length)return(0,i.jsx)("div",{style:{marginTop:20,marginBottom:20},children:"No valid authors found."});let t=s[0];return t.imageURL=t.image_url,t.page={permalink:"/homepage/blog/authors/"+t.key.replace(/([A-Z])/g,"-$1").toLowerCase()},console.log(t),(0,r.A)({author:t,as:e})}},28453:(n,e,s)=>{"use strict";s.d(e,{R:()=>i,x:()=>l});var t=s(96540);const a={},r=t.createContext(a);function i(n){const e=t.useContext(r);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),t.createElement(r.Provider,{value:e},n.children)}},39695:n=>{const e=[{"14thClassLeader":{name:"Miyun",title:"\u7b2c14\u5c46\u73ed\u9577",image_url:"https://github.com/Miyun-owo.png",page:!0,socials:{instgram:"https://www.instagram.com/miyun_owo/",github:"Miyun-owo"}},"14thAdvancedTeachingDirector":{name:"\u8349\u8c93",title:"\u7b2c\u5341\u56db\u5c46\u9032\u968e\u6559\u5b78 aka.\u67b6\u7db2\u7ad9\u7684\u90a3\u500b",url:"https://github.com/Bryan0324",image_url:"https://github.com/Bryan0324.png",page:!0,socials:{github:"https://github.com/Bryan0324",page:"https://bryan0324.github.io/"}},AdvancedTeachingAssistant:{name:"nowob"}}];n.exports=e.length<=1?e[0]:e},80644:(n,e,s)=>{"use strict";s.d(e,{Ay:()=>d,uw:()=>l});var t=s(96540),a=s(86025),r=s(74848);const i=t.createContext("@site/static/img"),l=({base:n,children:e})=>(0,r.jsx)(i.Provider,{value:n,children:e});function d({name:n,alt:e="",style:s}){const l=(0,t.useContext)(i);return console.log((0,a.Ay)(`${l}/${n}`)),(0,r.jsx)("img",{src:(0,a.Ay)(`${l}/${n}`),alt:e,style:s})}}}]);